<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parts Logger</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width:640px; margin:24px auto; padding:16px; }
    h1 { text-align:center; margin-bottom:16px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button { width:100%; padding:10px; font-size:15px; margin-top:6px; box-sizing:border-box; }
    #reader { width:100%; margin-top:10px; border:1px solid #eee; border-radius:6px; padding:8px; }
    .row { display:flex; gap:8px; }
    .small { flex:1; }
    #status { margin-top:12px; padding:10px; border-radius:6px; background:#f7f7f8; min-height:40px; }
    .hint { font-size:13px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Parts Logger</h1>

  <label>User</label>
  <select id="userSelect">
    <!-- Replace these options with your actual 5-10 names -->
    <option value="Shrish">Krishna</option>
    <option value="Alice">Sal</option>
    <option value="Bob">Jacob</option>
    <option value="Charlie">Aayush</option>
    <option value="Charlie">Pablo</option>
    <option value="Charlie">Shrish</option>
    <option value="Charlie">Jaya</option>
  </select>

  <label>Action</label>
  <select id="actionSelect">
    <option>Issue</option>
    <option>Return</option>
    <option>Discard</option>
  </select>

  <label>Part ID (scan or type)</label>
  <div class="row">
    <input id="partId" placeholder="Scan barcode or type Part ID (eg. P001)" />
    <button id="startScan" type="button" style="width:120px">Start Scan</button>
  </div>

  <div id="reader" style="display:none"></div>

  <div style="margin-top:12px">
    <button id="submitBtn">Log Action</button>
  </div>

  <div class="hint">If you use a USB/Bluetooth barcode scanner it will type the code directly into the Part ID box. No camera required.</div>

  <div id="status"></div>

  <script>
    // CONFIG: set your worker URL here (example: https://parts-logger.example.workers.dev)
    const WORKER_ENDPOINT = "https://YOUR_WORKER_SUBDOMAIN.workers.dev/log";

    const statusEl = document.getElementById('status');
    const partEl = document.getElementById('partId');
    const userEl = document.getElementById('userSelect');
    const actionEl = document.getElementById('actionSelect');
    const startScanBtn = document.getElementById('startScan');
    const readerDiv = document.getElementById('reader');

    function setStatus(txt, isError=false) {
      statusEl.innerText = txt;
      statusEl.style.color = isError ? 'crimson' : 'inherit';
    }

    // Scanner
    let html5QrCode = null;
    startScanBtn.addEventListener('click', async () => {
      if (readerDiv.style.display === 'none') {
        readerDiv.style.display = 'block';
        startScanBtn.innerText = 'Stop Scan';
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

        try {
          const cameras = await Html5Qrcode.getCameras();
          const cam = cameras.length ? cameras[0].id : null;
          await html5QrCode.start(
            cam ?? { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText, decodedResult) => {
              partEl.value = decodedText;
              // optionally auto-submit:
              // document.getElementById('submitBtn').click();
              setStatus("Scanned: " + decodedText);
            });
        } catch (e) {
          setStatus("Camera scan error: " + e, true);
        }
      } else {
        startScanBtn.innerText = 'Start Scan';
        readerDiv.style.display = 'none';
        if (html5QrCode) {
          try { await html5QrCode.stop(); } catch(e){/*ignore*/ }
        }
      }
    });

    // Submit
    document.getElementById('submitBtn').addEventListener('click', async () => {
      const partId = partEl.value.trim();
      const user = userEl.value;
      const action = actionEl.value;
      if (!partId) return setStatus("Please enter or scan a Part ID.", true);

      const payload = {
        PartID: partId,
        User: user,
        Action: action,
        Timestamp: new Date().toISOString()
      };

      setStatus("Sending...");
      try {
        const r = await fetch(WORKER_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!r.ok) {
          // try to show server message
          const t = await r.text();
          setStatus("Server error: " + r.status + " — " + t, true);
          // also store locally as fallback
          pushLocal(payload);
          return;
        }

        const data = await r.json().catch(()=>null);
        setStatus("✅ Logged: " + JSON.stringify(payload));
        partEl.value = '';
      } catch (err) {
        setStatus("Network error. Saved locally. " + err, true);
        pushLocal(payload);
      }
    });

    // LOCAL FALLBACK: store unsent logs in localStorage and allow CSV export
    function pushLocal(entry) {
      const key = 'parts_logger_offline';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(entry);
      localStorage.setItem(key, JSON.stringify(arr));
      setStatus("Saved offline. Go to Export to upload later.");
    }

    // Add a small Export link/UI
    const exportBtn = document.createElement('button');
    exportBtn.innerText = 'Export Offline CSV';
    exportBtn.style.marginTop = '12px';
    exportBtn.onclick = () => {
      const key = 'parts_logger_offline';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      if (!arr.length) return setStatus("No offline logs to export.");
      const csv = toCSV(arr);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'parts_logs_offline.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      localStorage.removeItem(key);
      setStatus("Exported CSV and cleared offline queue.");
    };
    document.body.appendChild(exportBtn);

    function toCSV(arr) {
      const keys = ["PartID","User","Action","Timestamp"];
      let out = keys.join(',') + '\n';
      for (const r of arr) {
        out += keys.map(k => `"${String(r[k] || '').replace(/"/g,'""')}"`).join(',') + '\n';
      }
      return out;
    }
  </script>
</body>
</html>
